# rego- AI å›¾åƒç”Ÿæˆå¹³å°

ä¸€ä¸ªåŸºäº **Google Vertex AI (Gemini)** çš„ AI å›¾åƒç”Ÿæˆå¹³å°ï¼Œå®Œå…¨é‡‡ç”¨ **Cloudflare Workers** åç«¯ï¼Œå‰ç«¯çº¯é™æ€ Web å®ç°ï¼Œæ— éœ€æœåŠ¡å™¨ï¼

![Platform](https://img.shields.io/badge/Platform-Cloudflare%20Workers-orange)
![AI](https://img.shields.io/badge/AI-Google%20Vertex%20AI-blue)
![Storage](https://img.shields.io/badge/Storage-Backblaze%20B2-green)
![Database](https://img.shields.io/badge/Database-Cloudflare%20D1-yellow)

## âœ¨ ç‰¹æ€§

- ğŸ¨ **AI å›¾åƒç”Ÿæˆ** - åŸºäº Google Vertex AI Gemini æ¨¡å‹
- ğŸ–¼ï¸ **å‚è€ƒå›¾æ”¯æŒ** - æ”¯æŒä¸Šä¼ æœ€å¤š 14 å¼ å‚è€ƒå›¾è¿›è¡Œåˆ›ä½œ
- ğŸ“ **å¤šç§æ¯”ä¾‹** - æ”¯æŒ 1:1ã€16:9ã€9:16 ç­‰å¤šç§ç”»é¢æ¯”ä¾‹
- ğŸ”’ **ç”¨æˆ·è®¤è¯** - JWT è®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒç”¨æˆ·é…é¢ç®¡ç†
- ğŸ« **å…‘æ¢ç ç³»ç»Ÿ** - ç®¡ç†å‘˜å¯ç”Ÿæˆå…‘æ¢ç åˆ†å‘é…é¢
- ğŸ“± **å“åº”å¼è®¾è®¡** - å®Œç¾é€‚é…ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯
- â˜ï¸ **Serverless** - å…¨ç¨‹ Cloudflare Workersï¼Œé›¶æœåŠ¡å™¨è¿ç»´
- ğŸš€ **CDN åŠ é€Ÿ** - å›¾ç‰‡é€šè¿‡ Cloudflare Edge ç¼“å­˜åŠ é€Ÿ

## ğŸ—ï¸ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend (Static)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  index.html â”‚  â”‚ admin.html  â”‚  â”‚  encrypt_tool.html  â”‚  â”‚
â”‚  â”‚   ä¸»åº”ç”¨    â”‚  â”‚   ç®¡ç†åå°   â”‚  â”‚     é…ç½®åŠ å¯†å·¥å…·     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Cloudflare Workers (Backend)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  AUTH Worker     â”‚  â”‚  API Worker  â”‚  â”‚  IMG Worker  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·ç™»å½•/æ³¨å†Œ   â”‚  â”‚ â€¢ å›¾åƒç”Ÿæˆ   â”‚  â”‚ â€¢ å›¾ç‰‡ä»£ç†   â”‚   â”‚
â”‚  â”‚ â€¢ JWT è®¤è¯       â”‚  â”‚ â€¢ Vertex AI  â”‚  â”‚ â€¢ CDN ç¼“å­˜   â”‚   â”‚
â”‚  â”‚ â€¢ é…é¢ç®¡ç†       â”‚  â”‚ â€¢ ä»»åŠ¡é˜Ÿåˆ—   â”‚  â”‚ â€¢ B2 ä¸‹è½½    â”‚   â”‚
â”‚  â”‚ â€¢ å…‘æ¢ç ç³»ç»Ÿ     â”‚  â”‚ â€¢ B2 ä¸Šä¼     â”‚  â”‚              â”‚   â”‚
â”‚  â”‚ â€¢ å›¾ç‰‡ä¸Šä¼        â”‚  â”‚              â”‚  â”‚              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                   â”‚                  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                   â”‚                  â”‚
            â–¼                   â–¼                  â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Cloudflare â”‚      â”‚ Google     â”‚     â”‚ Backblaze  â”‚
     â”‚    D1      â”‚      â”‚ Vertex AI  â”‚     â”‚    B2      â”‚
     â”‚ (Database) â”‚      â”‚ (Gemini)   â”‚     â”‚ (Storage)  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
rego/
â”œâ”€â”€ index.html              # ä¸»åº”ç”¨é¡µé¢
â”œâ”€â”€ admin.html              # ç®¡ç†åå°é¡µé¢
â”œâ”€â”€ encrypt_tool.html       # é…ç½®åŠ å¯†å·¥å…·
â”œâ”€â”€ config.json             # å‰ç«¯é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ style.css           # ä¸»æ ·å¼æ–‡ä»¶
â”‚   â”œâ”€â”€ responsive.css      # å“åº”å¼æ ·å¼
â”‚   â””â”€â”€ progress.css        # è¿›åº¦æ¡æ ·å¼
â”‚
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ main.js             # ä¸»åº”ç”¨é€»è¾‘
â”‚   â”œâ”€â”€ auth.js             # è®¤è¯æ¨¡å—
â”‚   â”œâ”€â”€ api.js              # API è°ƒç”¨æ¨¡å—
â”‚   â”œâ”€â”€ storage.js          # æœ¬åœ°å­˜å‚¨æ¨¡å— (IndexedDB)
â”‚   â””â”€â”€ admin.js            # ç®¡ç†åå°é€»è¾‘
â”‚
â””â”€â”€ backend/
    â”œâ”€â”€ API.js              # å›¾åƒç”Ÿæˆ Worker
    â”œâ”€â”€ AUTH and upload.js  # è®¤è¯ä¸ä¸Šä¼  Worker
    â””â”€â”€ IMG.js              # å›¾ç‰‡ä»£ç† Worker
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. å‰ç½®éœ€æ±‚

- **Cloudflare è´¦æˆ·** - ç”¨äºéƒ¨ç½² Workers å’Œ D1 æ•°æ®åº“
- **Google Cloud è´¦æˆ·** - ç”¨äº Vertex AI API
- **Backblaze B2 è´¦æˆ·** - ç”¨äºå›¾ç‰‡å­˜å‚¨

### 2. éƒ¨ç½² Cloudflare Workers

#### Worker 1: AUTH Worker (è®¤è¯ä¸ä¸Šä¼ )

1. åœ¨ Cloudflare Dashboard åˆ›å»º Worker
2. å¤åˆ¶ `backend/AUTH and upload.js` å…¨éƒ¨å†…å®¹
3. é…ç½® Bindings:
   - **D1 Database**: ç»‘å®šå˜é‡å `DB`
4. é…ç½® Environment Variables:

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `JWT_SECRET` | JWT ç­¾åå¯†é’¥ | `your-secret-key-here` |
| `B2_KEY_ID` | Backblaze B2 Key ID | `xxx` |
| `B2_APP_KEY` | Backblaze B2 App Key | `xxx` |
| `B2_BUCKET_NAME` | B2 Bucket åç§° | `my-bucket` |
| `IMG_RETURN_BASE` | å›¾ç‰‡è®¿é—®åŸŸå | `https://img.example.com` |

5. è®¿é—® `https://your-worker.workers.dev/__shujuku` åˆå§‹åŒ–æ•°æ®åº“

#### Worker 2: API Worker (å›¾åƒç”Ÿæˆ)

1. åœ¨ Cloudflare Dashboard åˆ›å»º Worker
2. å¤åˆ¶ `backend/API.js` å…¨éƒ¨å†…å®¹
3. é…ç½® Bindings:
   - **KV Namespace**: ç»‘å®šå˜é‡å `TASKS` (ç”¨äºä»»åŠ¡é˜Ÿåˆ—)
4. é…ç½® Environment Variables:

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `VERTEX_PROJECT_IDS` | GCP é¡¹ç›® ID (æ”¯æŒå¤šä¸ªç”¨ `|` åˆ†éš”è½®è¯¢) | `project1|project2` |
| `VERTEX_LOCATION` | Vertex AI åŒºåŸŸ | `global` |
| `VERTEX_MODEL` | æ¨¡å‹åç§° | `gemini-3-pro-image-preview` |
| `GCP_SERVICE_ACCOUNT_JSON` | GCP æœåŠ¡è´¦æˆ· JSON | `{...}` |
| `B2_KEY_ID` | Backblaze B2 Key ID | `xxx` |
| `B2_APP_KEY` | Backblaze B2 App Key | `xxx` |
| `B2_BUCKET_NAME` | B2 Bucket åç§° | `my-bucket` |
| `IMG_RETURN_BASE` | å›¾ç‰‡è®¿é—®åŸŸå | `https://img.example.com` |

#### Worker 3: IMG Worker (å›¾ç‰‡ä»£ç†)

1. åœ¨ Cloudflare Dashboard åˆ›å»º Worker
2. å¤åˆ¶ `backend/IMG.js` å…¨éƒ¨å†…å®¹
3. é…ç½® Environment Variables:

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `B2_KEY_ID` | Backblaze B2 Key ID | `xxx` |
| `B2_APP_KEY` | Backblaze B2 App Key | `xxx` |
| `B2_BUCKET_NAME` | B2 Bucket åç§° | `my-bucket` |

4. é…ç½®è‡ªå®šä¹‰åŸŸåï¼ˆç”¨ä½œ `IMG_RETURN_BASE`ï¼‰

### 3. é…ç½®å‰ç«¯

ç¼–è¾‘ `config.json`:

```json
{
  "authApi": "auth.your-domain.com",
  "imageApi": "api.your-domain.com"
}
```

### 4. éƒ¨ç½²å‰ç«¯

å°†å‰ç«¯æ–‡ä»¶éƒ¨ç½²åˆ°ä»»æ„é™æ€æ‰˜ç®¡æœåŠ¡:
- Cloudflare Pages
- GitHub Pages
- Vercel
- æˆ–ä»»ä½• HTTP æœåŠ¡å™¨

## ğŸ“š API æ–‡æ¡£

### AUTH Worker API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/auth/login` | POST | ç”¨æˆ·ç™»å½• |
| `/api/auth/me` | GET | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |
| `/api/users` | GET | è·å–ç”¨æˆ·åˆ—è¡¨ (ç®¡ç†å‘˜) |
| `/api/users` | POST | åˆ›å»ºç”¨æˆ· (ç®¡ç†å‘˜) |
| `/api/users/:id` | PUT | æ›´æ–°ç”¨æˆ· (ç®¡ç†å‘˜) |
| `/api/users/:id` | DELETE | åˆ é™¤ç”¨æˆ· (ç®¡ç†å‘˜) |
| `/api/quota` | GET | è·å–é…é¢ä¿¡æ¯ |
| `/api/quota/consume` | PUT | æ¶ˆè´¹é…é¢ |
| `/api/redeem` | POST | å…‘æ¢ç å…‘æ¢ |
| `/api/codes` | GET | è·å–å…‘æ¢ç åˆ—è¡¨ (ç®¡ç†å‘˜) |
| `/api/codes` | POST | ç”Ÿæˆå…‘æ¢ç  (ç®¡ç†å‘˜) |
| `/api/upload/image` | POST | ä¸Šä¼ å‚è€ƒå›¾åˆ° B2 |
| `/__shujuku` | GET | åˆå§‹åŒ–æ•°æ®åº“ |
| `/__b2check` | GET | æµ‹è¯• B2 é…ç½® |

### API Worker API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/generate` | POST | åˆ›å»ºå›¾åƒç”Ÿæˆä»»åŠ¡ |
| `/task/:id` | GET | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ |
| `/__health` | GET | å¥åº·æ£€æŸ¥ |
| `/__b2check` | GET | æµ‹è¯• B2 é…ç½® |
| `/__vertexcheck` | GET | æµ‹è¯• Vertex AI é…ç½® |

### IMG Worker API

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/i/:key` | GET | è·å–å›¾ç‰‡ (å¸¦ CDN ç¼“å­˜) |

## ğŸ” å®‰å…¨è¯´æ˜

1. **é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·**: `admin` / `admin`ï¼ˆéƒ¨ç½²åè¯·ç«‹å³ä¿®æ”¹å¯†ç ï¼‰
2. **JWT å¯†é’¥**: è¯·ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²
3. **é…ç½®åŠ å¯†**: ä½¿ç”¨ `encrypt_tool.html` åŠ å¯†æ•æ„Ÿé…ç½®
4. **CORS**: Workers å·²é…ç½®é€‚å½“çš„ CORS å¤´

## ğŸ› ï¸ æ•°æ®åº“ Schema

æ•°æ®åº“ä¼šåœ¨è®¿é—® `/__shujuku` æ—¶è‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«ä»¥ä¸‹è¡¨:

- **users** - ç”¨æˆ·è¡¨ (id, username, password, role, quota, used, ...)
- **redeem_codes** - å…‘æ¢ç è¡¨ (id, code, quota, used, used_by, ...)
- **usage_logs** - ä½¿ç”¨è®°å½•è¡¨ (id, user_id, action, details, ...)
- **history_records** - å†å²è®°å½•è¡¨ (id, user_id, prompt, image_url, ...)

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### å›¾åƒç”Ÿæˆ
- æ”¯æŒæ–‡æœ¬æç¤ºè¯ç”Ÿæˆå›¾åƒ
- æ”¯æŒ 1-2 å¼ å‚è€ƒå›¾è¿›è¡Œé£æ ¼è¿ç§»
- æ”¯æŒå¤šç§åˆ†è¾¨ç‡ (1K/2K/4K)
- æ”¯æŒå¤šç§ç”»é¢æ¯”ä¾‹ (1:1/16:9/9:16)
- å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒè¿›åº¦æŸ¥è¯¢

### ç”¨æˆ·ç³»ç»Ÿ
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- é…é¢ç®¡ç†
- å…‘æ¢ç ç³»ç»Ÿ
- ä½¿ç”¨è®°å½•è¿½è¸ª

### ç®¡ç†åå°
- ç”¨æˆ·ç®¡ç† (CRUD)
- å…‘æ¢ç ç”Ÿæˆä¸ç®¡ç†
- é…é¢åˆ†é…

### å‰ç«¯ç‰¹æ€§
- å“åº”å¼è®¾è®¡ï¼Œé€‚é…ç§»åŠ¨ç«¯
- æ‹–æ‹½æ’åºå‚è€ƒå›¾
- æ·±è‰²/æµ…è‰²ä¸»é¢˜åˆ‡æ¢
- å†å²è®°å½•æŒ‰æ—¥æœŸåˆ†ç»„
- å‚æ•°åŒºåŸŸå¯æŠ˜å ï¼ˆç§»åŠ¨ç«¯ï¼‰

## ğŸ“ License

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
